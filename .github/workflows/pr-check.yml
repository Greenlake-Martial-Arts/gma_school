name: GMA School PR Check

on:
  pull_request:
    branches:
      - "main"
      - "develop"
  push:
    branches:
      - "main"
      - "develop"
  workflow_dispatch:
    inputs:
      test_all_modules:
        description: 'Test all modules regardless of changes'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Detect changed modules
        id: changes
        run: |
          # Get list of changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Determine which modules are affected
          MODULES=""
          if echo "$CHANGED_FILES" | grep -q "^server/"; then
            MODULES="$MODULES :server:test"
          fi
          if echo "$CHANGED_FILES" | grep -q "^database/"; then
            MODULES="$MODULES :database:test"
          fi
          if echo "$CHANGED_FILES" | grep -q "^shared/"; then
            MODULES="$MODULES :shared:test"
          fi
          if echo "$CHANGED_FILES" | grep -q "^composeApp/"; then
            MODULES="$MODULES :composeApp:test"
          fi
          if echo "$CHANGED_FILES" | grep -q -E "^(gradle/|build\.gradle|settings\.gradle|gradle\.properties)"; then
            MODULES=":server:test :database:test :shared:test :composeApp:test"
          fi
          
          # If no modules detected or root files changed, test all
          if [ -z "$MODULES" ]; then
            MODULES=":server:test :database:test :shared:test :composeApp:test"
          fi
          
          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          echo "Testing modules: $MODULES"

      - name: Build application
        run: ./gradlew build --info --stacktrace

      - name: Run targeted tests
        run: |
          echo "Running tests for modules: ${{ steps.changes.outputs.modules }}"
          ./gradlew ${{ steps.changes.outputs.modules }} --info

      - name: Check for test results
        id: test_check
        run: |
          if find . -name "*.xml" -path "*/build/test-results/test/*" | grep -q .; then
            echo "test_files_exist=true" >> $GITHUB_OUTPUT
            echo "Test result files found"
          else
            echo "test_files_exist=false" >> $GITHUB_OUTPUT
            echo "No test result files found"
          fi

      - name: Publish Test Results
        uses: dorny/test-reporter@v1
        if: always() && steps.test_check.outputs.test_files_exist == 'true'
        with:
          name: Test Results
          path: '**/build/test-results/test/*.xml'
          reporter: java-junit
          fail-on-error: true

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            **/build/reports/tests/
            **/build/test-results/

      - name: Comment PR with test results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always()
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Find test result files
            const testResults = [];
            const findTestResults = (dir) => {
              const files = fs.readdirSync(dir, { withFileTypes: true });
              for (const file of files) {
                if (file.isDirectory()) {
                  findTestResults(path.join(dir, file.name));
                } else if (file.name.endsWith('.xml') && dir.includes('test-results')) {
                  testResults.push(path.join(dir, file.name));
                }
              }
            };
            
            try {
              findTestResults('.');
              const testCount = testResults.length;
              
              const comment = `## üß™ Test Results
              
              - **Test files found:** ${testCount}
              - **Build status:** ${{ job.status }}
              - **Workflow:** [View details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              ${testCount > 0 ? '‚úÖ Tests executed successfully!' : '‚ö†Ô∏è No test results found'}`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Error reading test results:', error);
            }
